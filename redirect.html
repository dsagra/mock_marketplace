<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redireccionando...</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .links {
            margin-top: 30px;
            font-size: 14px;
        }
        .links a {
            color: white;
            text-decoration: underline;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Redireccionando...</h1>
        <div class="spinner"></div>
        <p id="device-info">Detectando dispositivo...</p>
        <div class="links">
            <p>Si no te redirige automáticamente:</p>
            <a href="#" id="ios-link">Ir a iOS</a>
            <a href="#" id="android-link">Ir a Android</a>
        </div>
    </div>

    <script>
        // Función para obtener parámetros de la URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Obtener las URLs de los parámetros
        const iosUrl = getUrlParameter('ios') || 'https://apps.apple.com/';
        const androidUrl = getUrlParameter('android') || 'https://play.google.com/';
        const appScheme = getUrlParameter('app') || ''; // URL scheme de la app (ej: myapp://open)

        // Validar que las URLs sean válidas
        function isValidUrl(url) {
            if (!url || url.trim() === '') return false;
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }

        console.log('URLs recibidas:', { iosUrl, androidUrl, appScheme });
        console.log('URLs válidas:', { 
            ios: isValidUrl(iosUrl), 
            android: isValidUrl(androidUrl),
            app: appScheme ? isValidUrl(appScheme) : 'N/A'
        });

        // Actualizar los links manuales solo si son válidos
        if (isValidUrl(iosUrl)) {
            document.getElementById('ios-link').href = iosUrl;
        }
        if (isValidUrl(androidUrl)) {
            document.getElementById('android-link').href = androidUrl;
        }

        // Detectar el dispositivo
        function detectDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const platform = navigator.platform || '';
            
            console.log('User Agent:', userAgent);
            console.log('Platform:', platform);
            
            // Detectar iOS - múltiples métodos
            const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
            const isIOSPlatform = /iPad|iPhone|iPod/.test(platform);
            const isIOSTouch = navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(platform);
            
            if (isIOS || isIOSPlatform || isIOSTouch) {
                console.log('Detectado: iOS');
                return 'ios';
            }
            
            // Detectar Android
            if (/android/i.test(userAgent)) {
                console.log('Detectado: Android');
                return 'android';
            }
            
            // Desktop u otro dispositivo
            console.log('Detectado: Otro dispositivo');
            return 'other';
        }

        // Intentar abrir la app y si falla, ir a la tienda
        function tryOpenApp(appUrl, storeUrl, deviceType) {
            const deviceInfo = document.getElementById('device-info');
            
            console.log('tryOpenApp llamado:', { appUrl, storeUrl, deviceType });
            
            if (!appUrl) {
                // Si no hay URL de app, ir directo a la tienda
                deviceInfo.textContent = `Dispositivo ${deviceType} detectado. Redirigiendo a la tienda...`;
                console.log('Redirigiendo a:', storeUrl);
                setTimeout(() => {
                    console.log('Ejecutando redirección...');
                    window.location.href = storeUrl;
                }, 1500);
                return;
            }

            deviceInfo.textContent = `Intentando abrir la app...`;
            
            let appOpened = false;
            let timerCompleted = false;

            // Listener para detectar si perdemos el foco (la app se abrió)
            const blurHandler = () => {
                appOpened = true;
                console.log('Página perdió foco - app abierta');
            };
            
            const visibilityHandler = () => {
                if (document.hidden) {
                    appOpened = true;
                    console.log('Página oculta - app abierta');
                }
            };
            
            // Listener para antes de que la página se descargue (pagehide)
            const pageHideHandler = () => {
                appOpened = true;
                console.log('Página pagehide - app abierta');
            };
            
            // Listener para focus - la página recupera el foco si no se abrió la app
            const focusHandler = () => {
                console.log('Página recuperó foco - app probablemente no se abrió');
            };
            
            window.addEventListener('blur', blurHandler, false);
            document.addEventListener('visibilitychange', visibilityHandler, false);
            window.addEventListener('pagehide', pageHideHandler, false);
            window.addEventListener('focus', focusHandler, false);

            // Limpiar listeners
            const cleanup = () => {
                window.removeEventListener('blur', blurHandler);
                document.removeEventListener('visibilitychange', visibilityHandler);
                window.removeEventListener('pagehide', pageHideHandler);
                window.removeEventListener('focus', focusHandler);
            };

            // Intentar abrir la app directamente
            const attemptTime = Date.now();
            console.log('Intentando abrir app:', appUrl);
            
            // Método directo - funciona mejor en iOS
            window.location = appUrl;

            // Después de 3 segundos, verificar y redirigir si es necesario
            setTimeout(() => {
                cleanup();
                
                const elapsed = Date.now() - attemptTime;
                console.log('Tiempo transcurrido:', elapsed, 'ms. App abierta:', appOpened);
                
                if (!appOpened) {
                    console.log('App no se abrió, redirigiendo a tienda');
                    deviceInfo.textContent = `Redirigiendo a la tienda...`;
                    window.location.href = storeUrl;
                } else {
                    console.log('App abierta exitosamente');
                    deviceInfo.textContent = `¡App abierta!`;
                }
            }, 3000);
        }

        // Redirigir según el dispositivo
        const device = detectDevice();
        const deviceInfo = document.getElementById('device-info');

        // Si hay app scheme, intentar abrirla. Si no, ir directo a la tienda
        switch(device) {
            case 'ios':
                if (!isValidUrl(iosUrl)) {
                    deviceInfo.textContent = 'Error: URL de iOS no válida';
                    console.error('URL de iOS no válida:', iosUrl);
                    break;
                }
                if (appScheme) {
                    tryOpenApp(appScheme, iosUrl, 'iOS');
                } else {
                    deviceInfo.textContent = 'Dispositivo iOS detectado. Redirigiendo...';
                    console.log('Sin app scheme, redirigiendo directo a:', iosUrl);
                    setTimeout(() => {
                        window.location.href = iosUrl;
                    }, 1000);
                }
                break;
            case 'android':
                if (!isValidUrl(androidUrl)) {
                    deviceInfo.textContent = 'Error: URL de Android no válida';
                    console.error('URL de Android no válida:', androidUrl);
                    break;
                }
                if (appScheme) {
                    tryOpenApp(appScheme, androidUrl, 'Android');
                } else {
                    deviceInfo.textContent = 'Dispositivo Android detectado. Redirigiendo...';
                    console.log('Sin app scheme, redirigiendo directo a:', androidUrl);
                    setTimeout(() => {
                        window.location.href = androidUrl;
                    }, 1000);
                }
                break;
            default:
                deviceInfo.textContent = 'Dispositivo no móvil detectado. Por favor, selecciona tu plataforma:';
                break;
        }
    </script>
</body>
</html>
